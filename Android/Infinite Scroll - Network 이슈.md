# Recycler View - Infinite 스크롤 구현시 발생한 네트워크 이슈  
일반적으로 infinite 스크롤 작동방식은 다음과 같다.  
1. 스크롤이 Recycler view 최하단에 위치했을 때 이벤트를 캐치한다.  
2. 해당 이벤트 발생시 API 를 이용하여 새로운 데이터를 가져온다.  
3. 가져온 데이터를 Adapter에 Update 시켜준다.  
  
  
### Problem  
위 과정을 머리에 그리고 별 어려움 없이 구현을 마쳤다. 그런데 테스트 과정에서 스크롤하여 새로운 데이터를 로딩했을 때, 간혹 순서에 맞지 않는 녀석들이 있다는 제보를 받았다. API 콜을 날려보니 서버에서는 날짜 기준으로 잘 정렬하어 보내주고 있었다. 결국 안드로이드 구현문제! 더 당황스러운건 위 현상이 랜덤하게 발생하여 재현조건을 알 수 없다는 것이었다.  
  
### Think  
다시 Infinite 스크롤 작동 과정중 ** *해당 이벤트 발생시 API 를 이용하여 새로운 데이터를 가져온다.* ** 단계를 좀 더 자세히 살펴보면 항상 같은방식으로 동작하는 것이 아니라 상황에 따라 나뉘어 Best case 와 worst case 로 동작할 수 있음을 알 수 있다.  
  
**Best Case**  
(**서브 스레드** : API 콜 --> Response 성공! --> **UI 스레드** : Adapater 업데이트)  
  
**Worst Case**
(**서브 스레드1** : 첫번째 API 콜) --> (**UI 스레드** : 첫번째 API 콜에 대한 응답이 도착하기 전에 다시 최하단 스크롤 이벤트가 발생) --> (**서브스레드2** : 두번째 API 콜) --> ??? (결과 예측 불가)  
  
처음에 본인은 동기적인 사고방식을 통해 **스크롤 이벤트로 인한 최초의 API 콜**만 고려하여 항상 Best case 방식대로 동작한다고 생각했다.  
하지만 네트워크 처리는 비동기작업이기 때문에 다음과 같이 몇가지 특성을 고려해야 했다.  
1. API 콜이 불린 순간부터 API 결과에 대한 처리는 **서브스레드**에서,  API 콜을 부를 수 있는 이벤트는 **UI 스레드**에서 동작하기 때문에 이전에 API 콜이 불리고 결과가 돌아오기 전에 언제든 다시 새로운 API 콜을 부를 수 있다.  
2. 2번의 API 콜을 호출했을 때 먼저 호출한 API 콜의 결과가 항상 먼저 도착한다고 장담할 수 없다.
3. API 결과가 도착하는 순서는 장담할 수 없지만, API 콜을 호출한 순서대로 정렬된 데이터를 가져오기 때문에 늦게 때린 API 결과가 먼저 반영될 경우 사용자 입장에서는 순서가 중간에 뒤죽박죽으로 볼 수 있다.  
  
위의 특성을 알고나니 테스트과정에서 나타난 현상을 이해할 수 있었다.  
  
**본인이 원했던 과정** =  최하단 부분에서 스크롤을 할때마다 API 콜이 순차적으로 응답하여 최초 데이터 -> 데이터 1 -> 데이터 2 -> ... 순으로 나오는 것  
**실제 과정** = 데이터1 을 요청하는 API콜 1 -> (API 콜 1의 응답이 오기전에) 데이터2 를 요청하는 API 콜 2 -> API 콜 2의 응답 도착 -> API 콜 1의 응답  
최종 : 최초 데이터 - 데이터 2 - 데이터 1 순으로 보이게 됨.
  
### Solution
자, 그럼 위와 같은 상황을 어떻게 예방할 수 있을까?  
최초 API 콜의 응답이 끝나지 않았는데 계속해서 API 콜을 호출할 수 있는 것이 문제였으므로 이를 막아버리면 ok. 본인은 Flag로 **Lock**을 걸어버리는 방법을 이용했음.  
~~~java
private boolean dataLoading = false;

public void fetchData() {
    if (!dataLoading) {
      dataLoading = true;
      //================
      //Network 처리...
      //================

      //Network 처리가 끝난 후
      dataLoading = false;
    }
  }
~~~
위와 같이 처리하면 최초 API 콜이 끝나기 전까지는 이벤트가 발생해도 API 콜 요청이 모두 무시된다.  
OS에서 기본적으로 배우는 내용이 Lock, 세마포어 기법이었는데 막상 실전에서 코딩 할때는 전혀 떠오르지 않았다.. 네트워킹 작업을 할때는 순서가 보장되지 않는다는 것, 비동기!!!! 특성을 좀 더 이해하고 코딩하는 자세를 길러야겠다.



